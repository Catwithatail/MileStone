<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Active Jobs - FreelancePro</title>
    <link rel="stylesheet" href="/css/FreelancerD/static_elements/header.css" />
    <link rel="stylesheet" href="/css/FreelancerD/static_elements/sidebar.css" />
    <link rel="stylesheet" href="/css/FreelancerD/active_job_style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
  </head>
  <body>
    <div class="dashboard-wrapper">
      <!-- Sidebar -->
      <%- include('./partials/sidebar', {activePage: 'active_job'}) %>

      <!-- Main Content Area -->
      <div class="main-content">
        <!-- Header -->
        <header class="header">
          <h2>Milestone</h2>
          <div class="search-bar">
            <input
              type="text"
              class="search-input"
              placeholder="Search jobs, companies..."
            />
          </div>
          <div class="user-profile">
            <svg
              width="40px"
              height="40px"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C10.3431 6 9 7.34315 9 9C9 10.6569 10.3431 12 12 12C13.6569 12 15 10.6569 15 9C15 7.34315 13.6569 6 12 6ZM17.8946 17.4473L17.0002 17C17.8946 17.4473 17.8939 17.4487 17.8939 17.4487L17.8932 17.4502L17.8916 17.4532L17.8882 17.46L17.88 17.4756C17.8739 17.4871 17.8666 17.5004 17.858 17.5155C17.8409 17.5458 17.8186 17.5832 17.7906 17.6267C17.7346 17.7138 17.6558 17.8254 17.5497 17.9527C17.3369 18.208 17.0163 18.5245 16.5549 18.8321C15.6228 19.4534 14.1751 20 12.0001 20C8.31494 20 6.76549 18.4304 6.26653 17.7115C5.96463 17.2765 5.99806 16.7683 6.18066 16.4031C6.91705 14.9303 8.42234 14 10.069 14H13.7642C15.5134 14 17.1124 14.9883 17.8947 16.5528C18.0354 16.8343 18.0354 17.1657 17.8946 17.4473Z"
                fill="#152C70"
              />
            </svg>
            <span class="username"><%= user.name %></span>
          </div>
        </header>

        <!-- Active Jobs Section -->
        <div id="active-jobs" class="content-section active">
          <div class="content-header">
            <h2>Active Jobs</h2>
            <div class="sorting">
              <label for="sort-select">Sort by:</label>
              <select id="sort-select" class="sort-select">
                <option value="deadline">Deadline</option>
                <option value="recent">Most Recent</option>
                <option value="budget">Budget</option>
              </select>
            </div>
          </div>

          <div class="job-cards">
            <% active_jobs.forEach(job => { %>
            <div class="job-card" data-job-id="<%= job.id %>">
              <div class="job-company-logo">
                <img src="<%= job.logo %>" alt="<%= job.company %> Logo" />
              </div>
              <div class="job-info">
                <div class="job-header">
                  <h3 class="job-title"><%= job.title %></h3>
                  <div class="job-company"><%= job.company %></div>
                </div>
                <div class="job-progress">
                  <div class="progress-label">
                    <span>Milestone Progress</span>
                    <span><%= job.progress %>%</span>
                  </div>
                  <div class="progress-bar">
                    <div
                      class="progress-filled"
                      style="width: <%= job.progress %>%"
                    ></div>
                  </div>
                </div>
                <div class="job-tech">
                  <% job.tech.forEach(tech => { %>
                  <span class="tech-tag"><%= tech %></span>
                  <% }); %>
                </div>
                <div class="job-meta">
                  <div class="job-deadline">
                    <i class="far fa-clock"></i> <%= job.deadline %>
                  </div>
                  <div class="job-price"><%= job.price %></div>
                </div>
              </div>
              <div class="job-actions">
                <button
                  class="chat-btn"
                  onclick="window.location.href='/freelancerD/active_job/chat'"
                >
                  <i class="fas fa-comment"></i> Chat
                </button>
                <button
                  class="complain-btn"
                  onclick="leaveJob('<%= job.id %>')"
                >
                  <i class="fas fa-sign-out-alt"></i> Leave Job
                </button>
                <a
                  href="/freelancerD/job_history/jhistory_see_more"
                  class="see-more-btn"
                  >See More</a
                >
              </div>
            </div>
            <% }); %>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    async function leaveJob(jobId) {
      if (confirm("Are you sure you want to leave this job?")) {
        try {
          const response = await fetch(
            `/freelancerD/active_job/leave/${jobId}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (response.ok) {
            alert("Job left successfully!");
            document
              .querySelector(`.job-card[data-job-id="${jobId}"]`)
              .remove();
          } else {
            alert("Failed to leave the job. Please try again.");
          }
        } catch (error) {
          console.error("Error leaving job:", error);
          alert("An error occurred. Please try again.");
        }
      }
    }
  </script>
</html>
